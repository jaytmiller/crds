#! /usr/bin/env  pysh
#-*-python-*-

from collections import defaultdict
from pprint import pprint

usage("<PRD subarray file>", 1,  1,"""

Reduce a PRD subarray file into a dictionary of valid subarrays
which are organized by instrument.
""")

% grep -E 'Instrument\>|Subarray\>' $* | cut -d '>' -f 2 | cut -d '<' -f 1 > simplified

organized = defaultdict(set)
with open("simplified") as file:
     instrument = file.readline().strip()
     while instrument:
           subarray = file.readline().strip()
           organized[instrument].add(subarray)
           instrument = file.readline().strip()

% rm simplified

reorganized = dict()
for instrument in organized:
     reorganized[instrument] = sorted(list(organized[instrument])) + \
                               ["GENERIC","ANY","N/A"]

with open("subarrays.tpn", "w+") as file_:
     for instrument in reorganized:
          print(instrument.upper(), "---",  ",".join(reorganized[instrument]),
                file = file_)

with open("extracted_subarrays.dict", "w+") as file_:
          pprint(reorganized, stream=file_)



